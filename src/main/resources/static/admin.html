<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>관리자 콘솔</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --line:#e6e8ee; --txt:#1f2937; --muted:#6b7280;
      --brand:#2563eb; --danger:#ef4444; --success:#10b981; --shadow:0 8px 24px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;display:flex;flex-direction:column;gap:16px}
    header{display:flex;align-items:center;gap:12px;background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px 18px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:8px}
    .tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer}
    .tab.active{border-color:#c7d2fe;background:#eef2ff}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
    .row{display:flex;gap:8px;align-items:center}
    input,button,select{height:36px;border:1px solid var(--line);border-radius:10px;padding:0 10px;background:#fff}
    button{cursor:pointer}
    button.brand{background:var(--brand);border-color:transparent;color:#fff}
    button.danger{background:#fff;border-color:#fecaca;color:#b91c1c}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{font-weight:600;color:#334155;background:#f8fafc;position:sticky;top:0}
    .badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
    .pill{border:1px solid var(--line);border-radius:999px;padding:4px 10px;background:#fff;font-size:12px}
    .cols{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:980px){.cols{grid-template-columns:320px 1fr}}
    .list{max-height:520px;overflow:auto;border:1px dashed var(--line);border-radius:12px}
    .log{color:var(--muted);font-size:12px;max-height:120px;overflow:auto;border-top:1px dashed var(--line);padding-top:8px}
    .status-ok{color:var(--success)} .status-bad{color:#b91c1c}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="font-weight:700">관리자 콘솔</div>
    <div class="tabs">
      <div class="tab active" data-tab="rooms">채팅방</div>
      <div class="tab" data-tab="reports">신고</div>
      <div class="tab" data-tab="members">회원</div>
    </div>
    <div style="flex:1"></div>
    <span id="status" class="pill">READY</span>
  </header>

  <!-- 채팅방 -->
  <section id="tab-rooms" class="panel">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div style="font-weight:600">채팅방 목록</div>
      <div class="row">
        <button id="btnReloadRooms">새로고침</button>
      </div>
    </div>
    <div class="list">
      <table>
        <thead>
        <tr>
          <th style="width:120px">방ID</th>
          <th>제목</th>
          <th style="width:140px">메시지 수</th>
          <th style="width:140px">생성일</th>
          <th style="width:120px">관리</th>
        </tr>
        </thead>
        <tbody id="roomTbody"></tbody>
      </table>
    </div>
    <div id="roomLog" class="log"></div>
  </section>

  <!-- 신고 -->
  <section id="tab-reports" class="panel" style="display:none">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div style="font-weight:600">신고 목록</div>
      <div class="row">
        <button id="btnReloadReports">새로고침</button>
      </div>
    </div>
    <div class="list">
      <table>
        <thead>
        <tr>
          <th style="width:220px">신고ID</th>
          <th style="width:220px">메시지ID</th>
          <th style="width:110px">신고자ID</th>
          <th style="width:120px">피신고자ID</th>
          <th style="width:100px">사유</th>
          <th>상세</th>
          <th style="width:180px">생성시각</th>
          <th style="width:180px">수정시각</th>
          <th style="width:120px">액션</th>
        </tr>
        </thead>
        <tbody id="reportTbody"></tbody>
      </table>
    </div>
    <div id="reportLog" class="log"></div>
  </section>

  <!-- 회원 -->
  <section id="tab-members" class="panel" style="display:none">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div style="font-weight:600">회원 목록</div>
      <div class="row">
        <label class="pill">페이지 크기 20 (고정)</label>
        <button id="btnReloadMembers">새로고침</button>
      </div>
    </div>
    <div class="list">
      <table>
        <thead>
        <tr>
          <th style="width:100px">회원ID</th>
          <th style="width:160px">로그인ID</th>
          <th style="width:160px">이름</th>
          <th style="width:220px">이메일</th>
          <th style="width:90px">권한</th>
          <th style="width:110px">상태</th>
          <th style="width:140px">관리</th>
        </tr>
        </thead>
        <tbody id="memberTbody"></tbody>
      </table>
    </div>
    <div id="memberLog" class="log"></div>
  </section>
</div>

<script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const setStatus = t => $('#status').textContent = t;
    const logRoom = t => $('#roomLog').innerHTML += `<div>${t}</div>`;
    const logReport = t => $('#reportLog').innerHTML += `<div>${t}</div>`;
    const logMember = t => $('#memberLog').innerHTML += `<div>${t}</div>`;

    // 탭
    $$('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        $$('.tab').forEach(x=>x.classList.remove('active'));
        tab.classList.add('active');
        const name = tab.dataset.tab;
        ['rooms','reports','members'].forEach(n=>{
          $('#tab-'+n).style.display = (n===name)?'block':'none';
        });
      });
    });

    // ===== 채팅방 =====
    async function fetchRooms(){
      const res = await fetch('/api/v1/admin/chatrooms', {credentials:'include'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json(); // [{id,title,createdDate}]
    }
    async function fetchMsgCount(roomId){
      const res = await fetch(`/api/v1/admin/messages/count?roomId=${encodeURIComponent(roomId)}`, {credentials:'include'});
      if(!res.ok) throw new Error('count HTTP '+res.status);
      return res.json(); // number
    }
    async function deleteRoom(roomId){
      const res = await fetch(`/api/v1/admin/chatrooms/${roomId}`, {method:'DELETE', credentials:'include'});
      if(!res.ok) throw new Error('delete HTTP '+res.status);
    }

    async function loadRooms(){
      setStatus('방 불러오는 중…');
      $('#roomTbody').innerHTML = '';
      try{
        const rooms = await fetchRooms();
        // 먼저 기본 행을 그리고, 이후에 count 비동기 채우기
        for(const r of rooms){
          const tr = document.createElement('tr');
          tr.innerHTML = `
          <td>#${r.id}</td>
          <td>${escapeHtml(r.title||'')}</td>
          <td data-role="count"><span class="badge">조회중…</span></td>
          <td>${r.createdDate ? fmtDate(r.createdDate) : ''}</td>
          <td>
            <button class="danger" data-role="del">삭제</button>
          </td>
        `;
          // 삭제
          tr.querySelector('[data-role="del"]').addEventListener('click', async ()=>{
            if(!confirm(`#${r.id} 삭제할까요?`)) return;
            try{
              await deleteRoom(r.id);
              tr.remove();
              logRoom(`#${r.id} 삭제됨`);
            }catch(e){
              alert('삭제 실패: '+e.message); logRoom('오류: '+e.message);
            }
          });
          $('#roomTbody').appendChild(tr);
          // count 채우기
          (async ()=>{
            try{
              const c = await fetchMsgCount(r.id);
              tr.querySelector('[data-role="count"]').innerHTML = `<span class="badge">${c.toLocaleString()}건</span>`;
            }catch{ tr.querySelector('[data-role="count"]').innerHTML = `<span class="badge" style="color:#b91c1c;border-color:#fecaca">에러</span>`; }
          })();
        }
        setStatus(`방 ${rooms.length}개`);
      }catch(e){
        alert('방 목록 실패: '+e.message);
        logRoom('방 목록 실패: '+e.message);
        setStatus('오류');
      }
    }
    $('#btnReloadRooms').addEventListener('click', loadRooms);

    // ===== 신고 =====
    async function fetchReports(){
      const res = await fetch('/api/v1/admin/reports', {credentials:'include'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json(); // Flux -> JSON array
    }
    async function fetchMessage(id){
      const res = await fetch(`/api/v1/admin/messages/${encodeURIComponent(id)}`, {credentials:'include'});
      if(!res.ok) throw new Error('msg HTTP '+res.status);
      return res.json(); // {id,roomId,writerId,content,createdAt}
    }
    function renderReports(list){
      const tbody = $('#reportTbody');
      tbody.innerHTML = '';
      list.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td style="font-family:ui-monospace">${r.id ?? ''}</td>
        <td style="font-family:ui-monospace">${r.messageId ?? ''}</td>
        <td>${r.reporterId ?? ''}</td>
        <td>${r.reportedMemberId ?? ''}</td>
        <td>${r.reason ?? ''}</td>
        <td>${escapeHtml(r.detail ?? '')}</td>
        <td>${r.createdAt ? fmtDate(r.createdAt) : ''}</td>
        <td>${r.updatedAt ? fmtDate(r.updatedAt) : ''}</td>
        <td><button data-role="view">메시지 보기</button></td>
      `;
        tr.querySelector('[data-role="view"]').addEventListener('click', async ()=>{
          try{
            const m = await fetchMessage(r.messageId);
            alert(`메시지 #${m.id}\nroomId: ${m.roomId}\nwriterId: ${m.writerId}\n시간: ${m.createdAt}\n\n${m.content}`);
          }catch(e){
            alert('메시지 조회 실패: '+e.message); logReport('메시지 조회 실패: '+e.message);
          }
        });
        tbody.appendChild(tr);
      });
      setStatus(`신고 ${list.length}건`);
    }
    async function loadReports(){
      setStatus('신고 불러오는 중…');
      try{
        const list = await fetchReports();
        renderReports(list);
      }catch(e){
        alert('신고 목록 실패: '+e.message);
        logReport('신고 목록 실패: '+e.message);
        setStatus('오류');
      }
    }
    $('#btnReloadReports').addEventListener('click', loadReports);

    // ===== 회원 =====
    async function fetchMembers(page=0){
      const res = await fetch(`/api/v1/admin/members?page=${page}`, {credentials:'include'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json(); // Spring Page<AdminMemberDto>
    }
    async function toggleBan(memberId){
      const res = await fetch(`/api/v1/admin/members/${memberId}/status`, {method:'PATCH', credentials:'include'});
      if(!res.ok){
        // 서버는 ADMIN 밴 방지 등에서 4xx를 던짐
        const text = await res.text().catch(()=> '');
        throw new Error(`HTTP ${res.status} ${text||''}`);
      }
    }
    function renderMembers(page){
      const tbody = $('#memberTbody'); tbody.innerHTML = '';
      page.content.forEach(u=>{
        const tr = document.createElement('tr');
        const isBanned = (u.status === 'BANNED');
        tr.innerHTML = `
        <td>${u.memberId}</td>
        <td>${escapeHtml(u.loginId || '')}</td>
        <td>${escapeHtml(u.username || '')}</td>
        <td>${escapeHtml(u.email || '')}</td>
        <td>${u.role}</td>
        <td>${isBanned ? '<span class="status-bad">BANNED</span>' : '<span class="status-ok">UNBANNED</span>'}</td>
        <td><button data-role="ban">${isBanned ? '밴 해제' : '밴'}</button></td>
      `;
        tr.querySelector('[data-role="ban"]').addEventListener('click', async ()=>{
          if(isBanned){
            if(!confirm(`${u.username ?? u.memberId} 밴 해제할까요?`)) return;
          }else{
            if(!confirm(`${u.username ?? u.memberId} 을(를) 밴할까요?`)) return;
          }
          try{
            await toggleBan(u.memberId);
            // 토글 후 최신 상태 재조회
            const latest = await fetch(`/api/v1/admin/members/${u.memberId}`, {credentials:'include'});
            if(latest.ok){
              const data = await latest.json();
              // 간단히 셀만 갱신
              const bannedNow = (data.status === 'BANNED');
              tr.children[5].innerHTML = bannedNow ? '<span class="status-bad">BANNED</span>' : '<span class="status-ok">UNBANNED</span>';
              tr.querySelector('[data-role="ban"]').textContent = bannedNow ? '밴 해제' : '밴';
              logMember(`회원 #${u.memberId} 상태: ${data.status}`);
            }else{
              // 실패해도 전체 재로딩
              await loadMembers();
            }
          }catch(e){
            alert('상태 변경 실패: '+e.message);
            logMember('상태 변경 실패: '+e.message);
          }
        });
        tbody.appendChild(tr);
      });
      setStatus(`회원 ${page.numberOfElements}명 (page ${page.number+1}/${page.totalPages})`);
    }
    async function loadMembers(){
      setStatus('회원 불러오는 중…');
      try{
        const page = await fetchMembers(0);
        renderMembers(page);
      }catch(e){
        alert('회원 목록 실패: '+e.message);
        logMember('회원 목록 실패: '+e.message);
        setStatus('오류');
      }
    }
    $('#btnReloadMembers').addEventListener('click', loadMembers);

    // 유틸
    function fmtDate(x){
      // ISO 또는 Instant 문자열 처리
      try{ return new Date(x).toISOString().replace('T',' ').replace('Z','Z'); }
      catch{ return x; }
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    // 처음 진입 시 방/신고/회원 한 번씩 로딩(관리 편의)
    loadRooms();
    loadReports();
    loadMembers();
  })();
</script>
</body>
</html>