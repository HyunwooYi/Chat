<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>채팅방</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js" defer></script>
    <style>
        /* ===== Light theme palette ===== */
        :root{
            --bg:#f6f7fb;            /* 페이지 배경 */
            --panel:#ffffff;         /* 카드/패널 */
            --line:#e6e8ee;          /* 테두리 */
            --txt:#1f2937;           /* 본문 텍스트 */
            --muted:#6b7280;         /* 보조 텍스트 */
            --brand:#2563eb;         /* 브랜드/포커스 */
            --me:#2563eb;            /* 내 말풍선 */
            --you:#eef2ff;           /* 상대 말풍선(연한 인디고) */
            --you-txt:#1e293b;       /* 상대 말풍선 텍스트 */
            --success:#10b981;
            --danger:#ef4444;
            --shadow: 0 8px 24px rgba(15,23,42,.08);
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0; height:100dvh; overflow:hidden;
            background:var(--bg); color:var(--txt);
            font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
        }

        .app{height:100%; max-width:980px; margin:0 auto; display:flex; flex-direction:column; gap:16px; padding:16px}
        header{
            flex:0 0 auto; display:flex; align-items:center; gap:12px;
            padding:14px 18px; border:1px solid var(--line); border-radius:14px; background:var(--panel); box-shadow:var(--shadow)
        }
        header .title{font-weight:700; font-size:16px}
        header .sp{flex:1}

        /* controls */
        button, input{
            height:36px; border-radius:10px; padding:0 12px; transition:.15s ease;
            border:1px solid var(--line); background:#fff; color:var(--txt)
        }
        button{cursor:pointer; background:#fff}
        button:hover{box-shadow:0 4px 14px rgba(0,0,0,.06); transform:translateY(-1px)}
        button:active{transform:translateY(0)}
        input{background:#fff}
        input:focus{outline:none; border-color:#c7d2fe; box-shadow:0 0 0 4px rgba(99,102,241,.12)}

        main{
            flex:1 1 auto; min-height:0; display:grid; grid-template-columns:280px 1fr; gap:16px;
        }

        .panel{
            background:var(--panel); border:1px solid var(--line); border-radius:16px; min-height:0; box-shadow:var(--shadow)
        }

        /* rooms (좌측) */
        .rooms{padding:16px; display:flex; flex-direction:column; gap:12px; min-height:0}
        .row{display:flex; gap:8px}
        .rooms h3{margin:0 0 6px 0; font-size:12px; color:var(--muted); letter-spacing:.2px}
        .room-list{margin-top:6px; display:flex; flex-direction:column; gap:8px; flex:1 1 auto; min-height:0; overflow:auto; padding-right:2px}
        .room-item{
            display:flex; align-items:center; justify-content:space-between;
            border:1px solid var(--line); background:#fff; border-radius:12px; padding:10px 12px
        }
        .room-item:hover{border-color:#dbe1f1; box-shadow:0 4px 12px rgba(15,23,42,.06)}
        .room-item span{font-size:13px; color:#334155}
        .room-item button{height:30px; background:#f8fafc}
        .log{padding:10px; border-top:1px dashed var(--line); color:var(--muted); font-size:12px; max-height:120px; overflow:auto}

        /* chat (우측) */
        .chat{display:flex; flex-direction:column; min-height:0}
        .chat-header{
            flex:0 0 auto; padding:12px 16px; border-bottom:1px solid var(--line);
            display:flex; align-items:center; gap:10px
        }
        .chat-header .badge{
            font-size:12px; color:var(--success); border:1px solid var(--success);
            padding:2px 8px; border-radius:999px; background:#ecfdf5
        }
        .pill{
            font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--line);
            color:#334155; background:#fff
        }

        .messages{
            flex:1 1 auto; min-height:0; overflow:auto; padding:16px;
            display:flex; flex-direction:column; gap:12px; scroll-behavior:smooth;
            background:linear-gradient(180deg,#fafbff 0%, #f6f7fb 100%)
        }
        .msg{ max-width:60%; display:flex; flex-direction:column; gap:4px; }
        .me{align-self:flex-end}
        .you{align-self:flex-start}

        .bubble{
            display:inline-block;       /* ← 핵심: 블록 확장 금지 */
            padding:4px 8px;            /* 더 슬림하게 */
            border-radius:10px;
            border:1px solid var(--line);
            word-break:break-word;
            white-space:pre-wrap;
            font-size:13px;
            line-height:1.35;
            max-width:100%;
        }
        .me .bubble{background:var(--me); color:#fff; border-color:transparent; box-shadow:0 6px 14px rgba(37,99,235,.25)}
        .you .bubble{background:var(--you); color:var(--you-txt)}
        .meta{ font-size:11px; color:var(--muted); margin:0 }
        .composer{
            flex:0 0 auto; border-top:1px solid var(--line); padding:12px; display:flex; gap:8px; background:#fff; border-bottom-left-radius:16px; border-bottom-right-radius:16px
        }
        .composer input{flex:1}
        #bootError{background:#fee2e2;color:#991b1b;padding:10px;border:1px solid #fecaca;border-radius:10px;margin:12px}

        /* ==== 신고 모달 (라이트 톤) ==== */
        .modal-backdrop{position:fixed; inset:0; background:rgba(15,23,42,.28); display:none; align-items:center; justify-content:center; z-index:50}
        .modal{
            background:#ffffff; border:1px solid var(--line); border-radius:14px; padding:16px; width:min(460px, 92vw); color:var(--txt); box-shadow:var(--shadow)
        }
        .modal h4{margin:0 0 8px 0; font-size:15px}
        .modal .row{display:flex; gap:8px; margin-top:10px}
        .modal select, .modal textarea{
            width:100%; background:#fff; border:1px solid var(--line); color:var(--txt); border-radius:10px; padding:10px
        }
        .modal textarea{min-height:110px; resize:vertical}
        .modal .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
        .btn-secondary{background:#f8fafc; border:1px solid var(--line)}
        .badge-action{
            font-size:11px; border:1px solid var(--line); color:#334155; padding:3px 8px; border-radius:999px; cursor:pointer; user-select:none; background:#fff
        }
        .badge-action:hover{border-color:#d1d7e6; box-shadow:0 2px 8px rgba(0,0,0,.05)}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="title">Chat 채팅</div>
        <span id="meText" class="pill">로그인 필요</span>
        <div class="sp"></div>
        <button id="btnAdmin" style="display:none">관리자</button>
        <button id="btnLogin">구글 로그인</button>
        <button id="btnLogout" style="display:none">로그아웃</button>
    </header>

    <main>
        <section class="panel rooms">
            <h3>채팅방</h3>
            <div class="row">
                <input id="roomTitle" placeholder="새 방 제목" style="flex:1" />
                <button id="btnCreate">방 생성</button>
            </div>
            <div class="row">
                <button id="btnLeave">방 나가기</button>
            </div>
            <div class="row" style="margin-top:6px">
                <button id="btnReloadRooms">방 목록 새로고침</button>
            </div>
            <div class="room-list" id="roomList"></div>
            <div class="log" id="log"></div>
        </section>

        <section class="panel chat">
            <div class="chat-header">
                <div style="font-weight:600">현재 방</div>
                <div id="roomBadge" class="badge" style="display:none"></div>
                <div class="sp"></div>
                <div id="status" class="pill">WS 미연결</div>
            </div>
            <div id="bootError" style="display:none"></div>
            <div id="messages" class="messages"></div>
            <div class="composer">
                <input id="msg" placeholder="메시지를 입력하고 Enter" />
                <button id="btnSend">전송</button>
            </div>
        </section>
    </main>
</div>

<!-- 신고 모달 -->
<div id="reportBackdrop" class="modal-backdrop">
    <div class="modal">
        <h4>메시지 신고</h4>
        <div id="reportMsgPreview" class="pill" style="margin-bottom:8px"></div>
        <label style="font-size:12px;color:#9ca3af">신고 사유</label>
        <div class="row">
            <select id="reportReason">
                <option value="SPAM">스팸/광고</option>
                <option value="SEXUAL">음란물</option>
                <option value="ILLEGAL">불법/위험</option>
                <option value="ETC">기타</option>
            </select>
        </div>
        <label style="font-size:12px;color:#9ca3af; margin-top:8px; display:block">상세 설명 (선택)</label>
        <div class="row">
            <textarea id="reportDetail" placeholder="상세 내용을 적어주세요 (선택)"></textarea>
        </div>
        <div class="actions">
            <button id="btnReportCancel" class="btn-secondary">취소</button>
            <button id="btnReportSubmit">신고 제출</button>
        </div>
    </div>
</div>

<script defer>
    window.addEventListener('DOMContentLoaded', () => {
        try {
            (function () {
                const $ = (id) => document.getElementById(id);
                const showBootError = (text) => { const e=$('bootError'); e.textContent = '초기화 오류: ' + text; e.style.display='block'; };
                const log = (m) => { const el=$('log'); const t=new Date().toLocaleTimeString(); el.innerHTML += `<div>[${t}] ${m}</div>`; el.scrollTop = el.scrollHeight; };

                log('클라이언트 부팅 OK');

                // ===== 전역 상태 =====
                let me = null; // 내 정보 캐시

                // ===== 내 정보 보장 =====
                async function ensureMe() {
                    if (me) return me;
                    try {
                        const res = await fetch('/api/v1/members/me.json', { credentials:'include' });
                        if (!res.ok) return null;
                        me = await res.json(); // { memberId, username, email }
                        const meText = $('meText'); if (meText) meText.textContent = me.username;
                        log('내 정보 OK: ' + JSON.stringify(me));
                        return me;
                    } catch { return null; }
                }

                const btnLogout = document.getElementById('btnLogout');
                if (btnLogout) {
                    btnLogout.onclick = () => location.href = '/logout';
                }
                // 로그인되어 있으면 헤더를 즉시 갱신하고 로그인 버튼 숨김
                ensureMe().then(async (u) => {
                    if (u) {
                        const loginBtn = $('btnLogin');
                        if (loginBtn) loginBtn.style.display = 'none';
                        const logoutBtn = $('btnLogout');
                        if (logoutBtn) logoutBtn.style.display = 'inline-block';

                        // 관리자 권한 확인: ADMIN만 접근 가능한 엔드포인트를 톡톡 두들겨본다
                        try {
                            const res = await fetch(`/api/v1/admin/members/${u.memberId}`, { credentials: 'include' });
                            if (res.ok) {
                                // 관리자면 버튼 보이기
                                const btnAdmin = $('btnAdmin');
                                if (btnAdmin) btnAdmin.style.display = 'inline-block';
                            } else {
                                // 403 등은 무시 → 버튼 유지 숨김
                            }
                        } catch {
                            // 네트워크 오류 등은 무시
                        }
                    }
                });

                // ===== 이름 캐시/조회 =====
                const nameCache = new Map();
                const inflight = new Map();
                async function fetchName(id) {
                    if (nameCache.has(id)) return nameCache.get(id);
                    if (inflight.has(id)) return inflight.get(id);
                    const p = (async () => {
                        try {
                            const res = await fetch(`/api/v1/members/${id}`, { credentials:'include' });
                            if (!res.ok) return '익명';
                            const dto = await res.json();
                            const name = dto?.username || '익명';
                            nameCache.set(id, name);
                            return name;
                        } finally { inflight.delete(id); }
                    })();
                    inflight.set(id, p);
                    return p;
                }

                // ===== 중복 수신 방지(히스토리+실시간) =====
                const displayedIds = new Set();
                const markDisplayed = (id) => { if (id) displayedIds.add(id); };
                const hasDisplayed = (id) => id && displayedIds.has(id);

                // ===== 메시지 렌더링 (정렬/이름/시간) + 신고 버튼 =====
                async function appendMessage(msg) {
                    if (hasDisplayed(msg.id)) return;
                    if (!me) await ensureMe();

                    const box = $('messages'); if (!box) return;

                    const mine = !!(me && Number(msg.writerId) === Number(me.memberId));
                    const displayName = mine
                        ? (me?.username || '나')
                        : (msg.username || nameCache.get(msg.writerId) || '익명');

                    const row = document.createElement('div');
                    row.className = `msg ${mine ? 'me' : 'you'}`;

                    // 1) 이름(메타) - bubble 밖
                    const nameEl = document.createElement('div');
                    nameEl.className = 'meta';
                    nameEl.dataset.role = 'name';
                    nameEl.textContent = displayName;
                    row.appendChild(nameEl);

                    // 2) 말풍선(내용만)
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    const safe = (msg.content ?? '')
                        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    bubble.innerHTML = safe;
                    row.appendChild(bubble);

                    // 3) 시간(메타) - bubble 밖
                    const timeEl = document.createElement('div');
                    timeEl.className = 'meta';
                    timeEl.dataset.role = 'time';
                    timeEl.textContent = msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString() : '';
                    row.appendChild(timeEl);

                    // 4) 신고 버튼(내 메시지엔 표시 X) - bubble 옆에 작은 배지로
                    if (!mine) {
                        const action = document.createElement('div');
                        action.className = 'meta';
                        action.innerHTML = `<span class="badge-action" data-role="report" data-mid="${msg.id}">신고</span>`;
                        row.appendChild(action);

                        const btn = action.querySelector('[data-role="report"]');
                        btn.addEventListener('click', () => {
                            openReportModal(String(btn.getAttribute('data-mid')), bubble.textContent || '');
                        });
                    }

                    box.appendChild(row);
                    box.scrollTop = box.scrollHeight;

                    markDisplayed(msg.id);

                    // 상대 이름 비동기 보충
                    if (!mine && !msg.username) {
                        const name = await fetchName(msg.writerId);
                        if (nameEl && nameEl.textContent !== name) nameEl.textContent = name;
                    }
                }

                // ===== 로그인 버튼 =====
                $('btnLogin').onclick = () => location.href = '/oauth2/authorization/google';
                // ===== 관리자 버튼 =====
                $('btnAdmin').onclick = () => location.href = '/admin.html';

                // ===== 방 목록 =====
                async function loadRooms() {
                    try {
                        const res = await fetch('/api/v1/chatrooms/chatList', { credentials:'include' });
                        if (!res.ok) return log('방 목록 실패: HTTP ' + res.status);

                        const rooms = await res.json();
                        const box = $('roomList');
                        box.innerHTML = '';

                        rooms.forEach(r => {
                            const item = document.createElement('div');
                            item.className = 'room-item';
                            // ★ 버튼에 type="button" 명시
                            item.innerHTML = `
        <span>#${r.id} · ${r.title}</span>
        <button type="button" data-room="${r.id}">입장</button>
      `;

                            const btn = item.querySelector('button');
                            btn.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                log(`입장 클릭: #${r.id}`);
                                joinRoom(r.id);
                            });

                            box.appendChild(item);
                        });
                    } catch(e) {
                        log('방 목록 에러: ' + e);
                    }
                }
                $('btnReloadRooms').onclick = loadRooms; loadRooms();

                // ===== 방 생성 =====
                $('btnCreate').onclick = async () => {
                    const title = $('roomTitle').value.trim(); if (!title) return alert('방 제목을 입력하세요');
                    try {
                        const res = await fetch('/api/v1/chatrooms/create', {
                            method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({ title })
                        });
                        if (!res.ok) return log('방 생성 실패: HTTP ' + res.status);
                        const dto = await res.json();
                        log(`방 생성 성공: id=${dto.id}, title=${dto.title}`);
                        await loadRooms(); joinRoom(dto.id);
                    } catch(e){ log('방 생성 에러: ' + e); }
                };

                // ===== WS/STOMP =====
                let ws = null, stomp = null, currentSub = null, currentRoomId = null, connecting = false;
                function setStatus(t){ $('status').textContent = t; }
                function setRoomBadge(roomId){ const b=$('roomBadge'); if(!roomId){b.style.display='none'; b.textContent=''; return;} b.style.display='inline-block'; b.textContent='#'+roomId; }
                function clearMessages(){ $('messages').innerHTML=''; displayedIds.clear(); }

                function ensureWS(){
                    return new Promise((resolve,reject)=>{
                        if (stomp && stomp.connected) return resolve();
                        if (connecting) return resolve();
                        connecting = true;
                        ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');
                        stomp = Stomp.over(ws); stomp.debug=()=>{};
                        stomp.connect({}, ()=>{
                            connecting = false; setStatus('WS 연결됨'); resolve();
                        }, (err)=>{
                            connecting = false; setStatus('WS 오류'); log('STOMP 실패: '+err); reject(err);
                        });
                    });
                }

                // 과거 내역 로딩 (403이면 /join 후 1회 재시도)
                async function loadHistory(roomId) {
                    try {
                        const doFetch = async () =>
                            fetch(`/api/v1/chat?roomId=${encodeURIComponent(roomId)}`, { credentials:'include' });

                        // 1차 시도
                        let res = await doFetch();

                        // 인증 만료면 로그인 페이지로
                        if (res.status === 401) {
                            log('[히스토리 실패] 401 → 로그인 필요, 구글 로그인으로 이동');
                            location.href = '/oauth2/authorization/google';
                            return;
                        }

                        // 멤버십 없음(403) → 자동 가입 후 1회 재시도
                        if (res.status === 403) {
                            log('[히스토리 실패] 403 → 자동으로 /join 시도 후 재요청');
                            await fetch(`/api/v1/chatrooms/${roomId}/join`, { method:'POST', credentials:'include' });
                            res = await doFetch(); // 재시도

                            if (!res.ok) { // 그래도 실패면 로그만 남기고 종료
                                log(`[히스토리 실패-재시도] HTTP ${res.status}`);
                                return;
                            }
                        } else if (!res.ok) { // 그 외 실패
                            log(`[히스토리 실패] HTTP ${res.status}`);
                            return;
                        }

                        // 성공 처리
                        const list = await res.json();
                        list.sort((a,b) => (new Date(a.createdAt||0)) - (new Date(b.createdAt||0)));
                        for (const m of list) await appendMessage(m);
                        log(`히스토리 로드${res.status===403? '(재시도)': ''}: ${list.length}건`);
                    } catch (e) {
                        log('히스토리 에러: ' + e);
                    }
                }

                // 방 입장(Join + 구독 + 히스토리)
                async function joinRoom(roomId){
                    log(`joinRoom 호출: roomId=${roomId}`);
                    if(!roomId) return alert('roomId를 입력하세요');
                    await ensureMe(); // 정렬 정확도 ↑

                    if (currentRoomId === roomId && currentSub) { log(`[가드] 이미 #${roomId} 구독 중`); return; }

                    try{
                        await fetch(`/api/v1/chatrooms/${roomId}/join`, { method:'POST', credentials:'include' });
                        await ensureWS();

                        // 이전 구독 해제
                        if (currentSub) { try { currentSub.unsubscribe(); } catch {} currentSub = null; }

                        clearMessages();
                        currentRoomId = roomId; setRoomBadge(roomId);

                        currentSub = stomp.subscribe(`/sub/chatroom/${roomId}`, (frame)=>{
                            try { appendMessage(JSON.parse(frame.body)); }
                            catch { log('수신(원문): '+frame.body); }
                        });

                        log(`구독 완료: /sub/chatroom/${roomId}`);
                        await loadHistory(roomId);
                    }catch(e){ log('방 구독 에러: '+e); }
                }

                function leaveRoom(){
                    if(currentSub){ try{ currentSub.unsubscribe(); }catch{} }
                    currentSub=null; currentRoomId=null; setRoomBadge(null); clearMessages(); setStatus('WS 연결 유지(미구독)');
                }

                $('btnLeave').onclick = leaveRoom;

                // 메시지 전송
                function sendMessage(){
                    if(!stomp || !stomp.connected) return alert('먼저 방에 구독하세요');
                    if(!currentRoomId) return alert('현재 구독 중인 방이 없습니다');
                    const content = $('msg').value.trim();
                    if(!content) return;
                    stomp.send(`/pub/chat/${currentRoomId}`, {'content-type':'application/json'}, JSON.stringify({ content }));
                    $('msg').value = '';
                }
                $('btnSend').onclick = sendMessage;

                // 한글(IMe) 엔터 중복 방지
                const msgEl = $('msg');
                let isComposing = false;
                msgEl.addEventListener('compositionstart', () => { isComposing = true; });
                msgEl.addEventListener('compositionend', () => { isComposing = false; });
                msgEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        if (e.isComposing || isComposing || e.keyCode === 229) return;
                        e.preventDefault(); sendMessage();
                    }
                });

                // ==== 신고 API ====
                const REPORT_API = '/api/v1/reports'; // 서버 컨트롤러 prefix와 일치시켜야 함
                const reportState = { messageId: null, contentPreview: '' };

                function openReportModal(messageId, contentPreview) {
                    reportState.messageId = messageId;
                    reportState.contentPreview = contentPreview || '';
                    const b = $('reportBackdrop');
                    $('reportMsgPreview').textContent = `#${messageId} · ${(contentPreview||'').slice(0,40)}`;
                    $('reportReason').value = 'ABUSE';
                    $('reportDetail').value = '';
                    b.style.display = 'flex';
                }
                function closeReportModal() {
                    $('reportBackdrop').style.display = 'none';
                }
                $('btnReportCancel').onclick = closeReportModal;

                $('btnReportSubmit').onclick = async () => {
                    if (!reportState.messageId) return closeReportModal();

                    const payload = {
                        messageId: reportState.messageId, // 서버는 String(ObjectId) 기대
                        reason: $('reportReason').value,
                        detail: $('reportDetail').value?.trim() || null
                    };

                    try {
                        const res = await fetch(REPORT_API, {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            credentials: 'include',
                            body: JSON.stringify(payload)
                        });

                        if (res.status === 201) {
                            let body = null;
                            try { body = await res.json(); } catch {}
                            log(`신고 성공: id=${body?.id ?? '(바디 없음)'} reason=${payload.reason}`);
                            alert('신고가 접수되었습니다.');
                            closeReportModal();
                            return;
                        }
                        if (res.ok) {
                            log(`신고 성공(변형 응답): HTTP ${res.status}`);
                            alert('신고가 접수되었습니다.');
                            closeReportModal();
                            return;
                        }
                        if (res.status === 401) { alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.'); location.href='/oauth2/authorization/google'; return; }
                        if (res.status === 403) { alert('해당 방의 참여자만 신고할 수 있습니다.'); return; }
                        if (res.status === 404) { alert('메시지를 찾을 수 없습니다.'); return; }
                        if (res.status === 400) {
                            const err = await res.json().catch(()=> ({}));
                            alert('신고 실패(검증 오류): ' + JSON.stringify(err));
                            log('신고 실패 400: ' + JSON.stringify(err));
                            return;
                        }
                        const txt = await res.text().catch(()=> '');
                        alert('신고 실패: HTTP ' + res.status);
                        log('신고 실패: HTTP ' + res.status + ' ' + txt);
                    } catch (e) {
                        alert('신고 중 오류가 발생했습니다.');
                        log('신고 예외: ' + e);
                    }
                };

            })();
        } catch (err) {
            const box = document.getElementById('bootError');
            if (box) { box.textContent = '초기화 오류: ' + (err && err.message ? err.message : err); box.style.display = 'block'; }
            console.error(err);
        }
    });
</script>
</body>
</html>