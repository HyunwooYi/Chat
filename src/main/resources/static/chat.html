<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>채팅방</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        :root { --bg:#0f172a; --panel:#111827; --line:#1f2937; --me:#2563eb; --you:#374151; --txt:#e5e7eb; --muted:#9ca3af; }
        *{box-sizing:border-box}
        html, body { height: 100%; }
        body{ margin:0; height:100dvh; overflow:hidden; background:var(--bg); color:var(--txt); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

        .app{height:100%; max-width:980px; margin:0 auto; display:flex; flex-direction:column;}
        header{flex:0 0 auto; display:flex; align-items:center; gap:12px; padding:16px; border-bottom:1px solid var(--line)}
        header .title{font-weight:700} header .sp{flex:1}
        header button, header input{height:32px}
        button{background:#1f2937;border:1px solid #374151;color:#e5e7eb;border-radius:8px;padding:6px 10px;cursor:pointer}
        button:hover{border-color:#475569}
        input{background:#0b1220;border:1px solid #1e293b;color:#e5e7eb;border-radius:8px;padding:8px}

        main{flex:1 1 auto; min-height:0; display:grid; grid-template-columns:260px 1fr; gap:14px; padding:16px}
        .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;min-height:0}

        .rooms{padding:14px; display:flex; flex-direction:column; gap:10px; min-height:0}
        .row{display:flex; gap:8px}
        .rooms h3{margin:0 0 10px 0; font-size:13px; color:var(--muted); letter-spacing:.2px}
        .room-list{margin-top:10px; display:flex; flex-direction:column; gap:6px; flex:1 1 auto; min-height:0; overflow:auto}
        .room-item{display:flex; align-items:center; justify-content:space-between; border:1px solid #1f2937; background:#0b1220; border-radius:10px; padding:10px}
        .room-item span{font-size:13px; color:#cbd5e1}
        .room-item button{height:28px}
        .log{padding:10px; border-top:1px dashed var(--line); color:#94a3b8; font-size:12px; max-height:120px; overflow:auto}

        .chat{display:flex; flex-direction:column; min-height:0}
        .chat-header{flex:0 0 auto; padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px}
        .chat-header .badge{font-size:12px; color:#10b981; border:1px solid #10b981; padding:2px 8px; border-radius:999px}
        .pill{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #334155; color:#cbd5e1}

        .messages{flex:1 1 auto; min-height:0; overflow-y:auto; overflow-x:hidden; padding:14px; display:flex; flex-direction:column; gap:10px; scroll-behavior:smooth}

        .msg{max-width:55%; display:flex; flex-direction:column; font-size:13px}
        .me{align-self:flex-end} .you{align-self:flex-start}
        .me .bubble{background:var(--me)} .you .bubble{background:var(--you)}
        .bubble{padding:8px 10px; border-radius:12px; color:#fff; word-break:break-word; white-space:pre-wrap}
        .meta{font-size:11px; color:var(--muted); margin-top:4px}

        .composer{flex:0 0 auto; border-top:1px solid var(--line); padding:10px; display:flex; gap:8px; background:var(--panel)}
        .composer input{flex:1}
    </style>
</head>
<body>
<div class="app">
    <header>
        <div class="title">웹소켓 채팅</div>
        <span id="meText" class="pill">로그인 필요</span>
        <div class="sp"></div>
        <button id="btnLogin">구글 로그인</button>
        <button id="btnMe">내 정보 확인</button>
    </header>

    <main>
        <section class="panel rooms">
            <h3>채팅방</h3>
            <div class="row">
                <input id="roomTitle" placeholder="새 방 제목" style="flex:1" />
                <button id="btnCreate">방 생성</button>
            </div>
            <div class="row">
                <input id="roomId" placeholder="roomId" style="width:110px" />
                <button id="btnJoin">방 구독(Join + WS 연결)</button>
                <button id="btnLeave">연결 해제</button>
            </div>
            <div class="row" style="margin-top:6px">
                <button id="btnReloadRooms">방 목록 새로고침</button>
            </div>
            <div class="room-list" id="roomList"></div>
            <div class="log" id="log"></div>
        </section>

        <section class="panel chat">
            <div class="chat-header">
                <div style="font-weight:600">현재 방</div>
                <div id="roomBadge" class="badge" style="display:none"></div>
                <div class="sp"></div>
                <div id="status" class="pill">WS 미연결</div>
            </div>
            <div id="messages" class="messages"></div>
            <div class="composer">
                <input id="msg" placeholder="메시지를 입력하고 Enter" />
                <button id="btnSend">전송</button>
            </div>
        </section>
    </main>
</div>

<script>
    (function () {
        const $ = (id) => document.getElementById(id);
        const log = (m) => { const el=$('log'); const t=new Date().toLocaleTimeString(); el.innerHTML += `<div>[${t}] ${m}</div>`; el.scrollTop = el.scrollHeight; };

        // 로그인 정보
        let me = null;

        // 이름 캐시/조회
        const nameCache = new Map();
        const inflight = new Map();
        async function fetchName(id) {
            if (nameCache.has(id)) return nameCache.get(id);
            if (inflight.has(id)) return inflight.get(id);
            const p = (async () => {
                try {
                    const res = await fetch(`/api/v1/members/${id}`, { credentials:'include' });
                    if (!res.ok) return '익명';
                    const dto = await res.json();
                    const name = dto?.username || '익명';
                    nameCache.set(id, name);
                    return name;
                } finally { inflight.delete(id); }
            })();
            inflight.set(id, p);
            return p;
        }

        // 메시지 렌더링
        async function appendMessage(msg) {
            const box = $('messages'); if (!box) return;
            const mine = me && msg.writerId === me.memberId;
            let displayName = mine ? (me?.username || '나') : (msg.username || nameCache.get(msg.writerId) || '익명');

            const row = document.createElement('div');
            row.className = `msg ${mine ? 'me' : 'you'}`;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML =
                `<div class="meta" data-role="name">${displayName}</div>
       <div data-role="content">${msg.content ?? ''}</div>
       <div class="meta" data-role="time">${msg.createdAt ? new Date(msg.createdAt).toLocaleTimeString() : ''}</div>`;
            row.appendChild(bubble);
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;

            if (!mine && !msg.username) {
                const name = await fetchName(msg.writerId);
                const nameEl = bubble.querySelector('[data-role="name"]');
                if (nameEl && nameEl.textContent !== name) nameEl.textContent = name;
            }
        }

        // 로그인/내정보
        $('btnLogin').onclick = () => location.href = '/oauth2/authorization/google';
        $('btnMe').onclick = async () => {
            try {
                const res = await fetch('/api/v1/members/me.json', { credentials:'include' });
                if (!res.ok) { $('meText').textContent = '로그인 필요'; return log('내 정보 실패: HTTP ' + res.status); }
                me = await res.json(); $('meText').textContent = me.username; log('내 정보 OK: ' + JSON.stringify(me));
            } catch(e){ log('내 정보 에러: ' + e); }
        };

        // 방 목록
        async function loadRooms() {
            try {
                const res = await fetch('/api/v1/chatrooms/chatList', { credentials:'include' });
                if (!res.ok) return log('방 목록 실패: HTTP ' + res.status);
                const rooms = await res.json();
                const box = $('roomList'); box.innerHTML = '';
                rooms.forEach(r => {
                    const item = document.createElement('div');
                    item.className = 'room-item';
                    item.innerHTML = `<span>#${r.id} · ${r.title}</span><button data-room="${r.id}">입장</button>`;
                    item.querySelector('button').onclick = () => { $('roomId').value = r.id; joinRoom(r.id); };
                    box.appendChild(item);
                });
            } catch(e){ log('방 목록 에러: ' + e); }
        }
        $('btnReloadRooms').onclick = loadRooms; loadRooms();

        // 방 생성
        $('btnCreate').onclick = async () => {
            const title = $('roomTitle').value.trim(); if (!title) return alert('방 제목을 입력하세요');
            try {
                const res = await fetch('/api/v1/chatrooms/create', {
                    method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({ title })
                });
                if (!res.ok) return log('방 생성 실패: HTTP ' + res.status);
                const dto = await res.json();
                log(`방 생성 성공: id=${dto.id}, title=${dto.title}`);
                $('roomId').value = dto.id; await loadRooms(); joinRoom(dto.id);
            } catch(e){ log('방 생성 에러: ' + e); }
        };

        // WS/STOMP
        let ws = null, stomp = null, currentSub = null, currentRoomId = null, connecting = false;

        function setStatus(t){ $('status').textContent = t; }
        function setRoomBadge(roomId){ const b=$('roomBadge'); if(!roomId){b.style.display='none'; b.textContent=''; return;} b.style.display='inline-block'; b.textContent='#'+roomId; }
        function clearMessages(){ $('messages').innerHTML=''; }

        function ensureWS(){
            return new Promise((resolve,reject)=>{
                if (stomp && stomp.connected) return resolve();
                if (connecting) return resolve();          // 이미 연결 진행 중이면 대기만
                connecting = true;
                ws = new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');
                stomp = Stomp.over(ws); stomp.debug=()=>{};
                stomp.connect({}, ()=>{
                    connecting = false; setStatus('WS 연결됨'); resolve();
                }, (err)=>{
                    connecting = false; setStatus('WS 오류'); log('STOMP 실패: '+err); reject(err);
                });
            });
        }

        async function joinRoom(roomId){
            if(!roomId) return alert('roomId를 입력하세요');

            // ✅ 이미 같은 방 구독 중이면 재구독 금지
            if (currentRoomId === roomId && currentSub) {
                log(`[가드] 이미 #${roomId} 구독 중`);
                return;
            }

            try{
                await fetch(`/api/v1/chatrooms/${roomId}/join`, { method:'POST', credentials:'include' });

                await ensureWS();

                // ✅ 이전 구독 해지(확실히)
                if (currentSub) {
                    try { currentSub.unsubscribe(); } catch {}
                    currentSub = null;
                }

                clearMessages();
                currentRoomId = roomId; setRoomBadge(roomId);

                currentSub = stomp.subscribe(`/sub/chatroom/${roomId}`, (frame)=>{
                    try { appendMessage(JSON.parse(frame.body)); }
                    catch { log('수신(원문): '+frame.body); }
                });

                log(`구독 완료: /sub/chatroom/${roomId}`);
            }catch(e){ log('방 구독 에러: '+e); }
        }

        function leaveRoom(){
            if(currentSub){ try{ currentSub.unsubscribe(); }catch{} }
            currentSub=null; currentRoomId=null; setRoomBadge(null); clearMessages(); setStatus('WS 연결 유지(미구독)');
        }

        $('btnJoin').onclick = () => joinRoom(($('roomId').value||'').trim());
        $('btnLeave').onclick = leaveRoom;

        function sendMessage(){
            if(!stomp || !stomp.connected) return alert('먼저 방에 구독하세요');
            if(!currentRoomId) return alert('현재 구독 중인 방이 없습니다');
            const content = $('msg').value.trim();
            if(!content) return;
            stomp.send(`/pub/chat/${currentRoomId}`, {'content-type':'application/json'}, JSON.stringify({ content }));
            $('msg').value = '';
        }
        $('btnSend').onclick = sendMessage;

        // === 한글(IMe) 엔터 중복 방지 ===
        const msgEl = $('msg');
        let isComposing = false;

        msgEl.addEventListener('compositionstart', () => { isComposing = true; });
        msgEl.addEventListener('compositionend', () => { isComposing = false; });

        msgEl.addEventListener('keydown', (e) => {
            // Enter + 조합중이면 무시
            if (e.key === 'Enter' && !e.shiftKey) {
                // e.isComposing: 표준 플래그 (크롬/사파리)
                // keyCode 229: 일부 브라우저/플랫폼에서 조합중 신호
                if (e.isComposing || isComposing || e.keyCode === 229) {
                    return;
                }
                e.preventDefault(); // 폼 제출/개행 방지
                sendMessage();
            }
        });
    })();
</script>
</body>
</html>